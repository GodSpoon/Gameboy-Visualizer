<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gameboy Audio Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            overscroll-behavior: none; 
        }
        .gameboy-bg { background-color: #c0c0c0; } 
        .gameboy-screen-border { background-color: #708090; } 
        .gameboy-screen { background-color: #9bbc0f; }
        .gameboy-button {
            background-color: #525252; 
            color: white;
            border: 2px solid #303030;
            box-shadow: 2px 2px 0px #303030;
            user-select: none; 
            touch-action: manipulation; 
        }
        .gameboy-button:active {
            background-color: #404040;
            box-shadow: 1px 1px 0px #303030;
            transform: translate(1px, 1px);
        }
        .d-pad-button {
            background-color: #404040; 
            border: 2px solid #202020;
            box-shadow: 2px 2px 0px #202020;
            user-select: none;
            touch-action: manipulation;
        }
        .d-pad-button:active {
            background-color: #303030;
            box-shadow: 1px 1px 0px #202020;
            transform: translate(1px, 1px);
        }
        .menu-item.selected {
            background-color: rgba(255, 255, 255, 0.3);
            color: #0f380f; 
        }
        .pixelated {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        html, body {
            overflow: hidden;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .start-select-text {
            font-size: 0.5rem; 
            color: #303030;
            text-shadow: 1px 1px #a0a0a0;
            white-space: nowrap;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: 4px solid #0f380f; 
        }
        .modal-button {
            background-color: #0f380f; 
            color: #9bbc0f; 
            border: 2px solid #306230;
        }
        .modal-button:hover {
            background-color: #306230;
        }

        .theme-vaporwave .gameboy-bg { background-color: #ff71ce; }
        .theme-vaporwave .gameboy-screen-border { background-color: #01cdfe; }
        .theme-vaporwave .gameboy-screen { background-color: #05ffa1; }
        .theme-vaporwave .gameboy-button { background-color: #ff71ce; border-color: #b90085; box-shadow: 2px 2px 0px #b90085; }
        .theme-vaporwave .d-pad-button { background-color: #01cdfe; border-color: #008ea8; box-shadow: 2px 2px 0px #008ea8; }
        .theme-vaporwave .menu-item.selected { color: #ff71ce; }
        .theme-vaporwave .start-select-text { color: #b90085; text-shadow: 1px 1px #ffb8e7; }

        .theme-neo-vaporwave .gameboy-bg { background-color: #46244C; }
        .theme-neo-vaporwave .gameboy-screen-border { background-color: #712B75; }
        .theme-neo-vaporwave .gameboy-screen { background-color: #C74B50; }
        .theme-neo-vaporwave .gameboy-button { background-color: #D49B54; border-color: #8c6430; box-shadow: 2px 2px 0px #8c6430; }
        .theme-neo-vaporwave .d-pad-button { background-color: #712B75; border-color: #491c4c; box-shadow: 2px 2px 0px #491c4c; }
        .theme-neo-vaporwave .menu-item.selected { color: #D49B54; }
        .theme-neo-vaporwave .start-select-text { color: #712B75; text-shadow: 1px 1px #b17d91; }

        .theme-synthwave .gameboy-bg { background-color: #2c003e; }
        .theme-synthwave .gameboy-screen-border { background-color: #ff00ff; }
        .theme-synthwave .gameboy-screen { background-color: #00ffff; }
        .theme-synthwave .gameboy-button { background-color: #ff00ff; border-color: #a100a1; box-shadow: 2px 2px 0px #a100a1; }
        .theme-synthwave .d-pad-button { background-color: #ff6600; border-color: #a14000; box-shadow: 2px 2px 0px #a14000; }
        .theme-synthwave .menu-item.selected { color: #ff00ff; }
        .theme-synthwave .start-select-text { color: #ff00ff; text-shadow: 1px 1px #ffb3ff; }

        .theme-gameboy-green .gameboy-bg { background-color: #c0c0c0; }
        .theme-gameboy-green .gameboy-screen-border { background-color: #708090; }
        .theme-gameboy-green .gameboy-screen { background-color: #9bbc0f; }
        .theme-gameboy-green .gameboy-button { background-color: #525252; border-color: #303030; box-shadow: 2px 2px 0px #303030; }
        .theme-gameboy-green .d-pad-button { background-color: #404040; border-color: #202020; box-shadow: 2px 2px 0px #202020; }
        .theme-gameboy-green .menu-item.selected { color: #0f380f; }
        .theme-gameboy-green .start-select-text { color: #303030; text-shadow: 1px 1px #a0a0a0; }

        .glitch { animation: glitch-anim 0.5s infinite alternate; }
        @keyframes glitch-anim {
            0% { transform: translate(0, 0); opacity: 1; } 20% { transform: translate(-2px, 2px); opacity: 0.8; }
            40% { transform: translate(2px, -2px); opacity: 1; } 60% { transform: translate(-1px, 1px); filter: hue-rotate(90deg); opacity: 0.9; }
            80% { transform: translate(1px, -1px); filter: hue-rotate(0deg); opacity: 1; } 100% { transform: translate(0, 0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-black flex items-center justify-center h-screen overflow-hidden theme-gameboy-green">

    <div id="gameboy-container" class="gameboy-bg relative w-full h-full sm:w-[360px] sm:h-[600px] md:w-[400px] md:h-[660px] lg:w-[450px] lg:h-[750px] p-3 sm:p-4 rounded-lg shadow-2xl flex flex-col select-none">
        <div class="gameboy-screen-border w-full flex-grow mb-3 sm:mb-4 rounded-md p-2 sm:p-3 flex items-center justify-center">
            <div id="screen-wrapper" class="relative w-full h-full">
                <canvas id="visualizerCanvas" class="gameboy-screen w-full h-full pixelated rounded-sm"></canvas>
                <div id="menuOverlay" class="absolute inset-0 bg-black bg-opacity-80 text-white p-3 sm:p-4 flex flex-col justify-center items-center hidden text-sm sm:text-base">
                    <h2 class="text-lg sm:text-xl mb-3 sm:mb-4">MENU</h2>
                    <ul id="menuItems" class="w-full text-center"></ul>
                    <p class="mt-3 sm:mt-4 text-xs">D-Pad/Arrows, A/Z: Select, B/X: Back</p>
                </div>
                <div id="messageBox" class="absolute inset-x-2 sm:inset-x-4 bottom-2 sm:bottom-4 bg-black bg-opacity-80 text-white p-2 text-center text-xs sm:text-sm hidden rounded">
                    <p id="messageText"></p>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0">
            <div class="text-center mb-2 sm:mb-3">
                <span class="text-red-600 font-bold italic text-sm sm:text-lg" style="font-family: Arial, sans-serif;">N i n t e n d o</span>
                <span class="text-red-600 font-bold text-lg sm:text-2xl align-middle" style="font-family: Arial, sans-serif;"> GAME BOY</span>
                <span class="text-red-600 text-xs align-super" style="font-family: Arial, sans-serif;">™</span>
            </div>
            <div class="grid grid-cols-3 gap-2 sm:gap-3 items-center justify-items-center mb-2 sm:mb-3">
                <div class="flex justify-center items-center">
                    <div class="grid grid-cols-3 grid-rows-3 w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24">
                        <div></div> <button id="btn-up" class="d-pad-button col-start-2 rounded-t-md text-sm sm:text-base">▲</button> <div></div>
                        <button id="btn-left" class="d-pad-button row-start-2 rounded-l-md text-sm sm:text-base">◀</button>
                        <div class="bg-gray-700 row-start-2 col-start-2"></div>
                        <button id="btn-right" class="d-pad-button row-start-2 col-start-3 rounded-r-md text-sm sm:text-base">▶</button>
                        <div></div> <button id="btn-down" class="d-pad-button row-start-3 col-start-2 rounded-b-md text-sm sm:text-base">▼</button> <div></div>
                    </div>
                </div>
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="w-8 sm:w-10 space-y-0.5 sm:space-y-1 opacity-50">
                        <div class="h-0.5 sm:h-1 bg-gray-700 rounded-full"></div> <div class="h-0.5 sm:h-1 bg-gray-700 rounded-full"></div>
                        <div class="h-0.5 sm:h-1 bg-gray-700 rounded-full"></div> <div class="h-0.5 sm:h-1 bg-gray-700 rounded-full"></div>
                        <div class="h-0.5 sm:h-1 bg-gray-700 rounded-full"></div>
                    </div>
                </div>
                <div class="flex justify-center items-center space-x-2 sm:space-x-3">
                    <button id="btn-b" class="gameboy-button w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full text-sm sm:text-base font-bold">B</button>
                    <button id="btn-a" class="gameboy-button w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full text-sm sm:text-base font-bold">A</button>
                </div>
            </div>
            <div class="flex justify-center items-center space-x-4 sm:space-x-6 mt-1 sm:mt-2">
                <div class="text-center">
                    <button id="btn-select" class="gameboy-button w-10 h-4 sm:w-14 sm:h-5 md:w-16 md:h-6 rounded-full"></button>
                    <p class="start-select-text mt-0.5 sm:mt-1">SELECT</p>
                </div>
                <div class="text-center">
                    <button id="btn-start" class="gameboy-button w-10 h-4 sm:w-14 sm:h-5 md:w-16 md:h-6 rounded-full"></button>
                    <p class="start-select-text mt-0.5 sm:mt-1">START</p>
                </div>
            </div>
        </div>
    </div>

    <div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center z-50 p-4">
        <div class="modal p-6 sm:p-8 rounded-lg text-center max-w-md">
            <h1 class="text-xl sm:text-2xl md:text-3xl mb-4">Gameboy Visualizer</h1>
            <p class="mb-6 sm:mb-8 text-xs sm:text-sm md:text-base">Welcome! This app uses your microphone for audio visualization. Please grant permission when prompted.</p>
            <button id="startAppButton" class="modal-button px-4 py-2 sm:px-6 sm:py-3 text-base sm:text-lg md:text-xl rounded-md hover:bg-opacity-80 transition-colors">
                Start Visualizer
            </button>
            <p class="text-xs mt-6 opacity-70">Press Enter or click Start to begin.</p>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const canvas = document.getElementById('visualizerCanvas');
        const ctx = canvas.getContext('2d');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuItemsElement = document.getElementById('menuItems');
        const permissionModal = document.getElementById('permissionModal');
        const startAppButton = document.getElementById('startAppButton');
        const gameboyContainer = document.getElementById('gameboy-container');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // --- Audio Context and Analyzer ---
        let audioContext;
        let analyser;
        let source;
        let dataArray; 
        let waveformArray; 
        let bufferLength;

        // --- Visualizer State ---
        let currentColorScheme = 'gameboy-green';
        let currentVisualizer = 'bars'; 
        let currentAudioSource = 'mic'; 
        let glitchEffectActive = false;
        let isFullScreen = false;
        let animationFrameId;
        let audioInitialized = false;

        // --- Pokemon Sprite Specific State ---
        const POKEMON_SPRITE_BASE_URL_GEN5_ANIMATED = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/';
        // Let's pick a few Gen V Pokemon known to have animated sprites
        const gen5PokemonIds = [
            495, 496, 497, // Snivy, Servine, Serperior
            498, 499, 500, // Tepig, Pignite, Emboar
            501, 502, 503, // Oshawott, Dewott, Samurott
            570, 571, // Zorua, Zoroark
            610, 611, 612, // Axew, Fraxure, Haxorus
            624, 625, // Pawniard, Bisharp
            633, 634, 635 // Deino, Zweilous, Hydreigon
        ];
        let loadedPokemonSprites = [];
        let currentPokemonSprite = null;
        let spriteX, spriteY, spriteVY; // For position and vertical velocity (for jumping)
        const SPRITE_BASE_SIZE = 64; // Base size for drawing sprites
        const SPRITE_GROUND_Y_OFFSET = 20; // How far from bottom sprite 'stands'
        let spriteIsJumping = false;
        let spriteLoadAttempted = false;


        // --- Menu State ---
        let menuOpen = false;
        let currentMenuIndex = 0;
        const menuStructure = [
            { 
                name: "Visualizer", 
                options: ['Bars', 'Waveform', 'Sprites'], 
                action: (option) => { 
                    currentVisualizer = option.toLowerCase(); 
                    showMessage(`Visualizer: ${option}`);
                    if (currentVisualizer === 'sprites' && loadedPokemonSprites.length === 0 && !spriteLoadAttempted) {
                        loadPokemonSpriteGroup(gen5PokemonIds); // Load Gen V animated sprites
                    } else if (currentVisualizer === 'sprites' && loadedPokemonSprites.length > 0 && !currentPokemonSprite) {
                        selectRandomPokemonSprite(); // Select one if already loaded
                    }
                }
            },
            { 
                name: "Color Scheme", 
                options: ['Gameboy Green', 'Vaporwave', 'Neo-Vaporwave', 'Synthwave'], 
                action: (option) => { 
                    const schemeClass = 'theme-' + option.toLowerCase().replace(/ /g, '-');
                    document.body.className = document.body.className.replace(/theme-\S+/g, ''); 
                    document.body.classList.add(schemeClass);
                    currentColorScheme = schemeClass;
                    showMessage(`Color Scheme: ${option}`);
                } 
            },
            { // Changed from "Pokemon Sprite" to "Next Sprite"
                name: "Next Sprite",
                options: ['Change'], // Simplified options
                action: () => {
                    if (currentVisualizer === 'sprites') {
                        selectRandomPokemonSprite();
                        if(currentPokemonSprite) showMessage(`Sprite: Random!`);
                        else showMessage(`No sprites loaded yet.`);
                    } else {
                        showMessage("Switch to Sprites visualizer first.");
                    }
                }
            },
            { 
                name: "Glitch Effect", 
                options: ['Off', 'On'], 
                action: (option) => { 
                    glitchEffectActive = option === 'On';
                    if (glitchEffectActive) canvas.classList.add('glitch');
                    else canvas.classList.remove('glitch');
                    showMessage(`Glitch: ${glitchEffectActive ? 'On' : 'Off'}`);
                } 
            },
            { 
                name: "Audio Source", 
                options: ['Microphone', 'System (N/A)'], 
                action: (option) => { 
                    if (option === 'Microphone') {
                        currentAudioSource = 'mic';
                        if (!audioInitialized || (audioContext && audioContext.state === 'suspended')) {
                           if(audioContext && audioContext.state === 'suspended') {
                                audioContext.resume().then(() => {
                                    if (!source || !source.mediaStream || !source.mediaStream.active) initAudio();
                                }).catch(e => console.error("Error resuming AudioContext:", e));
                            } else initAudio();
                        }
                        showMessage("Audio: Mic");
                    } else showMessage("System audio not available.");
                } 
            },
            { name: "Fullscreen", options: ['Toggle'], action: () => toggleFullScreen() },
            { name: "Close Menu", options: [], action: () => toggleMenu(false) }
        ];
        let activeSubMenu = null; 
        let currentSubMenuIndex = 0;

        // --- Sprite Loading Functions ---
        function loadPokemonSpriteGroup(ids) {
            spriteLoadAttempted = true;
            showMessage("Loading Pokémon sprites...", 2500);
            let loadedCount = 0;
            ids.forEach(id => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Important for some environments if sprites were on different domains
                img.onload = () => {
                    loadedPokemonSprites.push({id: id, image: img, name: `Pokemon ${id}` }); // Store with ID for potential future use
                    loadedCount++;
                    if (loadedCount === ids.length) {
                        showMessage(`${loadedCount} sprites loaded!`, 2000);
                        if (currentVisualizer === 'sprites' && !currentPokemonSprite) {
                            selectRandomPokemonSprite();
                        }
                    }
                };
                img.onerror = () => {
                    console.warn(`Failed to load sprite for Pokémon ID: ${id}`);
                    // Potentially remove this ID or mark as failed if retrying
                };
                img.src = `${POKEMON_SPRITE_BASE_URL_GEN5_ANIMATED}${id}.gif`;
            });
        }

        function selectRandomPokemonSprite() {
            if (loadedPokemonSprites.length > 0) {
                const randomIndex = Math.floor(Math.random() * loadedPokemonSprites.length);
                currentPokemonSprite = loadedPokemonSprites[randomIndex].image;
                // Initialize sprite position
                spriteX = canvas.width / 2;
                spriteY = canvas.height - SPRITE_GROUND_Y_OFFSET - SPRITE_BASE_SIZE / 2; // Centered above ground
                spriteVY = 0; // Vertical velocity
                spriteIsJumping = false;
            } else {
                currentPokemonSprite = null;
                if (spriteLoadAttempted) showMessage("No sprites loaded. Check console.", 3000);
                else showMessage("Loading sprites or none available.", 3000);
            }
        }
        
        // --- Utility Functions ---
        function showMessage(text, duration = 2000) { /* Unchanged */ }
        function toggleFullScreen() { /* Unchanged */ }

        // --- Audio Initialization ---
        async function initAudio() { /* Unchanged, but ensure it's robust */ }

        // --- Canvas Resizing and Drawing ---
        function resizeCanvas() { /* Unchanged */ }

        function draw() {
            animationFrameId = requestAnimationFrame(draw);
            ctx.fillStyle = getComputedStyle(canvas).backgroundColor || '#9bbc0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!audioInitialized || !analyser) {
                // Idle screen text (unchanged)
                const currentBg = getComputedStyle(canvas).backgroundColor;
                const r = parseInt(currentBg.slice(1,3), 16);
                const g = parseInt(currentBg.slice(3,5), 16);
                const b = parseInt(currentBg.slice(5,7), 16);
                const brightness
